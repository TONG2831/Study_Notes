

# 线程安全

## 1.什么是线程安全?

> 谷歌的定义：如果一段代码可以保证多个线程访问的时候正确操作共享数据，那么它是线程安全的。
>
> 所以什么是线程安全，多个线程访问一段代码时，能正确操作共享数据，就是线程安全。

## 2.线程安全的核心关键词

**共享数据**

## 3.引入的相关概念

### 3.1有状态对象和无状态对象

- **有状态对象**（stateful）：有数据存储功能，存在可以改变属性值的类属性（全局变量）。
- **无状态对象**（stateless）：不存在类属性，或存在类属性但该属性没有状态，无法操作属性值。

> **总结，无状态的bean是线程线程安全的。**

举例：

```java
public class StatefulBean {
    private int state;
    //该属性在外界可以修改,因此是有状态bean
    private Student stu;
}
```

### 3.2不变模式

> 一个类的内部状态创建后，在整个生命周期内状态不会发生改变，称为不变类。使用不变类的行为是不变模式。
>
> 不变模式又分为：弱不变模式和强不变模式

1. **弱不变模式：**

   类的实例状态不能改变，但是类引用的实例可能会发生改变状态。这样的类符合弱不变模式的定义。如果要实现弱不变模式，需要满足如下条件：

   - 类通过构造函数初始化之后，该对象状态不再改变。
   - 所有属性应该是私有的
   - 如果对象引用的对象是可变对象，那么必须设法限制外界对该对象的访问，防止修改。如果可能，尽量在不变对象内部初始化。

2. **强不变模式**

   一个类的实例和该类的子类的实例都具有不可变状态。所以强不变模式具备弱不变模式的所有条件。

   同时应该满足一下条件之一：

   - 类的所有方法为final，这样类的子类不能再置换此类的方法。
   - 该类为final，不存在子类

### 3.3不变模式的应用

- 单例模式，单例模式又可以分为`有状态单例`和`无状态单例`,很明显，`无状态的单例`线程安全
- 享元模式，。。。
- 原型模式，原型模式，每次请求时创建一个新的实例。
- 线程池、缓存...

**在Spring中的体现：**

Spring中对于Controller层、Service层、Dao层Bean的默认实现为`SingleTon`。

